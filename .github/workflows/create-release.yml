# Create Release Workflow
#
# This workflow creates a release tag and optionally builds/pushes the maas-api image.
#
# Usage:
#   1. Go to Actions > Create Release > Run workflow
#   2. Enter the tag (e.g., v1.0.0)
#   3. Optionally enable "Build and push maas-api image to quay.io"
#   4. Optionally enable "Create GitHub release"
#
# What it does:
#   - Updates kustomization files with the new tag
#   - Commits the changes locally
#   - Creates and pushes a git tag (tag only, not the branch)
#   - Optionally builds and pushes the maas-api image to quay.io
#   - Optionally creates a GitHub release
#
# Tag Management:
#   The workflow updates image tags in these files:
#   - deployment/base/maas-api/kustomization.yaml
#   - maas-api/deploy/overlays/dev/kustomization.yaml
#   - maas-api/deploy/overlays/odh/params.env
#
# Note: The tag is pushed separately from the branch. The commit with updated
#       tags exists only in the tag, not on the main branch.
#
# The docs-version workflow is automatically triggered when this workflow completes

name: Create Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        type: string
      build_and_push:
        description: 'Build and push maas-api image to quay.io'
        required: false
        type: boolean
        default: false
      quay_repo:
        description: 'Quay.io repository (e.g., quay.io/maas/maas-api)'
        required: false
        type: string
        default: 'quay.io/maas/maas-api'
      create_release:
        description: 'Create GitHub release'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Fetch all history for tags
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Validate tag format
        run: |
          TAG="${{ inputs.tag }}"
          if [[ ! "$TAG" =~ ^v?[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$ ]]; then
            echo "Warning: Tag '$TAG' doesn't follow semantic versioning format (v1.0.0)"
            echo "Continuing anyway..."
          fi

      # Update all kustomization files with the new tag using the helper script
      - name: Update kustomization files with new tag
        run: |
          chmod +x scripts/update-kustomize-tag.sh
          ./scripts/update-kustomize-tag.sh "${{ inputs.tag }}"

      - name: Verify changes
        run: |
          echo "Verifying tag updates..."
          git diff --no-color || true
          
          # Check if files were actually updated
          if ! git diff --quiet; then
            echo "✓ Files updated successfully"
          else
            echo "⚠ No changes detected. Tag may already be set."
          fi

      - name: Commit changes
        run: |
          git add deployment/base/maas-api/kustomization.yaml
          git add maas-api/deploy/overlays/dev/kustomization.yaml || true
          git add maas-api/deploy/overlays/odh/params.env || true
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          git commit -m "chore: update image tag to ${{ inputs.tag }}"
          
      # Create and push the git tag. Note: Only the tag is pushed, not the branch.
      # The commit with updated tags exists in the tag but not on the main branch.
      # The docs-version workflow will be triggered via workflow_run when this workflow completes.
      - name: Create and push git tag
        run: |
          TAG="${{ inputs.tag }}"
          
          # Check if tag already exists
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists. Deleting existing tag..."
            git tag -d "$TAG" || true
            git push origin ":refs/tags/$TAG" || true
          fi
          
          # Create annotated tag pointing to current commit
          git tag -a "$TAG" -m "Release $TAG"
          # Push only the tag, not the branch (this ensures tag-specific changes stay in the tag)
          git push origin "$TAG"


      - name: Setup Go
        if: inputs.build_and_push == true
        uses: actions/setup-go@v6
        with:
          go-version-file: maas-api/go.mod
          cache: true
          cache-dependency-path: maas-api/go.sum

      - name: Login to Quay.io
        if: inputs.build_and_push == true
        uses: docker/login-action@v3
        with:
          registry: quay.io
          username: ${{ secrets.APP_QUAY_USERNAME }}
          password: ${{ secrets.APP_QUAY_TOKEN }}

      - name: Build and Push image to Quay.io
        if: inputs.build_and_push == true
        run: |
          cd maas-api
          make build-push-image REPO="${{ inputs.quay_repo }}" TAG="${{ inputs.tag }}" CONTAINER_ENGINE=docker

      - name: Create GitHub Release
        if: inputs.create_release == true
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.tag }}
          name: Release ${{ inputs.tag }}
          body: |
            This release updates the MaaS billing deployment manifests to use image tag `${{ inputs.tag }}`.
            
            ### Updated Files
            - `deployment/base/maas-api/kustomization.yaml`
            - `maas-api/deploy/overlays/dev/kustomization.yaml`
            - `maas-api/deploy/overlays/odh/params.env`
            
            > Note: Release notes can be edited after creation.
          draft: false
          prerelease: ${{ contains(inputs.tag, '-') || contains(inputs.tag, 'alpha') || contains(inputs.tag, 'beta') || contains(inputs.tag, 'rc') }}

      - name: Summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Tag**: \`${{ inputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Git Tag**: Created and pushed" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.build_and_push }}" == "true" ]; then
            echo "✅ **Image Built & Pushed**: \`${{ inputs.quay_repo }}:${{ inputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ inputs.create_release }}" == "true" ]; then
            echo "✅ **GitHub Release**: Created" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Updated Files" >> $GITHUB_STEP_SUMMARY
          echo "- \`deployment/base/maas-api/kustomization.yaml\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`maas-api/deploy/overlays/dev/kustomization.yaml\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`maas-api/deploy/overlays/odh/params.env\`" >> $GITHUB_STEP_SUMMARY

